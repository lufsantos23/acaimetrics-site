<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A√ßa√≠Metrics | v9.7 Final</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; margin-bottom: 20px; }
        input, select { background-color: #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; border: 1px solid #475569; margin-bottom: 10px; outline: none; }
        input:focus, select:focus { border-color: #9333ea; }
        button { cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-primary { background-color: #9333ea; color: white; font-weight: bold; padding: 10px 20px; border-radius: 8px; width: 100%; }
        .btn-success { background-color: #16a34a; color: white; font-weight: bold; padding: 10px 20px; border-radius: 8px; width: 100%; }
        .btn-danger { color: #f87171; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #475569; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    </style>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.body.innerHTML = '<div style="color:red; padding:20px; background:#330000; font-size:18px; font-family:monospace;"><h1>Erro Cr√≠tico Detectado!</h1><p>'+message+'</p><p>Linha: '+lineno+'</p><p>Verifique se copiou o c√≥digo completo.</p></div>';
        };
    </script>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ==========================================================
        // ‚ö†Ô∏è COLE SUAS CHAVES ABAIXO (Mantenha as aspas!)
        // ==========================================================
        const SUPABASE_URL = "https://gmbtewbpojuqrnehrfmk.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtYnRld2Jwb2p1cXJuZWhyZm1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyODE0MTQsImV4cCI6MjA4MTg1NzQxNH0.F2K_ZzXCJAFDplTqSK0ubq5zfSXItjIatZnb-pdOAOQ";
        // ==========================================================

        let client = null;
        let erroConfig = null;

        try {
            if (!SUPABASE_URL || SUPABASE_URL.includes("SUA_URL")) throw new Error("ERRO: Configure a URL do Supabase na linha 58.");
            if (!SUPABASE_KEY || SUPABASE_KEY.includes("SUA_CHAVE")) throw new Error("ERRO: Configure a CHAVE do Supabase na linha 59.");
            client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (err) {
            erroConfig = err.message;
        }

        const Icon = ({ name, size=20 }) => {
            useEffect(() => { if(lucide) lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }}></i>;
        };

        // --- M√ìDULO 1: ESTOQUE (Calculadora Autom√°tica) ---
        const ModuloEstoque = () => {
            const [items, setItems] = useState([]);
            const [form, setForm] = useState({ nome: '', unidade_medida: 'G', categoria: 'ingrediente', preco_embalagem: '', tamanho_embalagem: '' });

            useEffect(() => { carregar(); }, []);
            async function carregar() { const { data } = await client.from('insumos').select('*').order('nome'); if (data) setItems(data); }

            async function salvar() {
                if (!form.nome || !form.preco_embalagem || !form.tamanho_embalagem) return alert("Preencha todos os campos!");
                const custoCalculado = Number(form.preco_embalagem) / Number(form.tamanho_embalagem);
                
                await client.from('insumos').insert([{ 
                    nome: form.nome, categoria: form.categoria, unidade_medida: form.unidade_medida, custo_atual: custoCalculado 
                }]);
                
                setForm({ nome: '', unidade_medida: 'G', categoria: 'ingrediente', preco_embalagem: '', tamanho_embalagem: '' }); 
                carregar();
            }
            async function excluir(id) { if (confirm("Tem certeza que deseja apagar?")) { await client.from('insumos').delete().eq('id', id); carregar(); } }

            return (
                <div className="space-y-6 animate-fade">
                    <h2 className="text-2xl font-bold text-white mb-4">Estoque & Insumos</h2>
                    <div className="card">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="text-sm text-slate-400">Nome do Item</label><input value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} placeholder="Ex: Leite em P√≥, A√ßa√≠ Puro" /></div>
                            <div><label className="text-sm text-slate-400">Categoria</label><select value={form.categoria} onChange={e=>setForm({...form, categoria:e.target.value})}><option value="ingrediente">Ingrediente</option><option value="embalagem">Embalagem</option></select></div>
                            <div><label className="text-sm text-slate-400">Pre√ßo Pago na Nota (R$)</label><input type="number" value={form.preco_embalagem} onChange={e=>setForm({...form, preco_embalagem:e.target.value})} placeholder="Ex: 85.00" /></div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-sm text-slate-400">Quantidade Total</label><input type="number" value={form.tamanho_embalagem} onChange={e=>setForm({...form, tamanho_embalagem:e.target.value})} placeholder="Ex: 7000 (para 7kg)" /></div>
                                <div className="w-1/3"><label className="text-sm text-slate-400">Unid</label><select value={form.unidade_medida} onChange={e=>setForm({...form, unidade_medida:e.target.value})}><option value="G">Grama</option><option value="ML">ML</option><option value="UN">Unidade</option></select></div>
                            </div>
                        </div>
                        <button onClick={salvar} className="btn-primary w-full">Salvar Item</button>
                    </div>
                    <div className="card overflow-x-auto">
                        <table className="w-full text-left text-sm text-slate-300">
                            <thead><tr className="border-b border-slate-600"><th className="p-3">Nome</th><th className="p-3">Custo Unit.</th><th className="p-3">A√ß√£o</th></tr></thead>
                            <tbody>
                                {items.map(i => (
                                    <tr key={i.id} className="border-b border-slate-700/50">
                                        <td className="p-3 font-bold text-white">{i.nome}</td>
                                        <td className="p-3 text-green-400">R$ {Number(i.custo_atual).toFixed(4)} / {i.unidade_medida}</td>
                                        <td className="p-3"><button onClick={()=>excluir(i.id)} className="text-red-400 hover:text-red-300 font-bold">Excluir</button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- M√ìDULO 2: MEUS PRODUTOS (Receitas) ---
        const ModuloProdutos = () => {
            const [produtos, setProdutos] = useState([]);
            const [nomeNovo, setNomeNovo] = useState('');
            const [produtoEdit, setProdutoEdit] = useState(null);

            useEffect(() => { carregar(); }, []);
            async function carregar() { const { data } = await client.from('produtos').select('*').order('created_at'); if(data) setProdutos(data); }
            
            async function criar() {
                if(!nomeNovo) return alert("Digite um nome!");
                await client.from('produtos').insert([{ nome: nomeNovo, preco_base: 0 }]);
                setNomeNovo(''); carregar();
            }

            async function excluirProduto(id) {
                if(confirm("Isso apagar√° o produto e a receita. Continuar?")) {
                    await client.from('produtos').delete().eq('id', id);
                    carregar();
                }
            }

            async function salvarEdicao() {
                if(!produtoEdit || !produtoEdit.nome) return;
                await client.from('produtos').update({ nome: produtoEdit.nome }).eq('id', produtoEdit.id);
                setProdutoEdit(null);
                carregar();
            }

            const DetalheReceita = ({ produto }) => {
                const [itens, setItens] = useState([]);
                const [insumos, setInsumos] = useState([]);
                const [addId, setAddId] = useState('');
                const [addQtd, setAddQtd] = useState('');

                useEffect(() => { loadItens(); loadInsumos(); }, []);
                async function loadInsumos() { const {data} = await client.from('insumos').select('*').order('nome'); if(data) setInsumos(data); }
                async function loadItens() { const {data} = await client.from('itens_receita').select('*, insumos(*)').eq('produto_id', produto.id); if(data) setItens(data); }
                
                async function adicionar() {
                    if(!addId || !addQtd) return;
                    await client.from('itens_receita').insert([{ produto_id: produto.id, insumo_id: addId, quantidade: addQtd }]);
                    setAddQtd(''); loadItens();
                }
                async function remover(id) { await client.from('itens_receita').delete().eq('id', id); loadItens(); }

                const custoTotal = itens.reduce((acc, i) => acc + (Number(i.quantidade) * Number(i.insumos?.custo_atual||0)), 0);

                return (
                    <div className="mt-4 bg-slate-900 p-4 rounded border border-slate-700">
                        <p className="text-xs text-slate-400 mb-2 uppercase font-bold">Ingredientes:</p>
                        {itens.map(i => (
                            <div key={i.id} className="flex justify-between text-sm mb-2 border-b border-slate-800 pb-1">
                                <span>{i.insumos?.nome} ({Number(i.quantidade)} {i.insumos?.unidade_medida})</span>
                                <div className="flex gap-4">
                                    <span className="text-green-400 font-mono">R$ {(Number(i.quantidade)*Number(i.insumos?.custo_atual)).toFixed(2)}</span>
                                    <button onClick={()=>remover(i.id)} className="text-red-500 font-bold">X</button>
                                </div>
                            </div>
                        ))}
                        <div className="flex gap-2 mt-4">
                            <select value={addId} onChange={e=>setAddId(e.target.value)} className="text-sm flex-1">
                                <option value="">+ Adicionar Item...</option>
                                {insumos.map(i=><option key={i.id} value={i.id}>{i.nome}</option>)}
                            </select>
                            <input type="number" placeholder="Qtd" value={addQtd} onChange={e=>setAddQtd(e.target.value)} className="w-20 text-sm" />
                            <button onClick={adicionar} className="bg-green-600 px-3 rounded text-white font-bold">+</button>
                        </div>
                        <div className="mt-4 pt-3 border-t border-slate-700 flex justify-between items-center">
                            <span className="text-slate-400">Custo Total (CMV):</span>
                            <span className="text-xl font-bold text-green-400">R$ {custoTotal.toFixed(2)}</span>
                        </div>
                    </div>
                );
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-white mb-4">Engenharia de Card√°pio</h2>
                    <div className="card flex gap-2">
                        <input placeholder="Nome do Produto (Ex: Copo 500ml)" value={nomeNovo} onChange={e=>setNomeNovo(e.target.value)} />
                        <button onClick={criar} className="btn-primary w-auto whitespace-nowrap">Criar Produto</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {produtos.map(p => (
                            <div key={p.id} className="card relative">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold text-lg text-white flex items-center gap-2"><Icon name="coffee" /> {p.nome}</h3>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setProdutoEdit(p)} className="bg-slate-800 p-2 rounded hover:text-blue-400"><Icon name="pencil" size={16}/></button>
                                        <button onClick={()=>excluirProduto(p.id)} className="bg-slate-800 p-2 rounded hover:text-red-400"><Icon name="trash-2" size={16}/></button>
                                    </div>
                                </div>
                                <DetalheReceita produto={p} />
                            </div>
                        ))}
                    </div>
                    
                    {produtoEdit && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-xl font-bold text-white mb-4">Renomear Produto</h3>
                                <input value={produtoEdit.nome} onChange={e=>setProdutoEdit({...produtoEdit, nome:e.target.value})} className="mb-4" />
                                <div className="flex gap-2">
                                    <button onClick={()=>setProdutoEdit(null)} className="btn-danger w-full">Cancelar</button>
                                    <button onClick={salvarEdicao} className="btn-success w-full">Salvar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- M√ìDULO 3: PRECIFICA√á√ÉO (Promo√ß√£o) ---
        const ModuloPrecificacao = () => {
            const [custoProd, setCustoProd] = useState('');
            const [lucro, setLucro] = useState(20);
            const [imposto, setImposto] = useState(4);
            const [canais, setCanais] = useState([]);
            const [canalEdit, setCanalEdit] = useState(null);

            useEffect(() => { carregarCanais(); }, []);
            async function carregarCanais() { const { data } = await client.from('canais_venda').select('*'); if (data) setCanais(data); }

            async function salvarCanal() {
                if(!canalEdit) return;
                await client.from('canais_venda').update({
                    comissao_percentual: canalEdit.comissao_percentual,
                    custo_frete_fixo: canalEdit.custo_frete_fixo,
                    cupom_desconto_fixo: canalEdit.cupom_desconto_fixo,
                    desconto_cliente_percentual: canalEdit.desconto_cliente_percentual
                }).eq('id', canalEdit.id);
                setCanalEdit(null);
                carregarCanais();
            }

            const calcular = (canal) => {
                const custoBase = Number(custoProd);
                const fixos = custoBase + Number(canal.custo_frete_fixo||0) + Number(canal.cupom_desconto_fixo||0);
                const percentuais = imposto + Number(canal.comissao_percentual||0) + Number(canal.desconto_cliente_percentual||0) + lucro;
                if (percentuais >= 100) return 0;
                return fixos / (1 - (percentuais / 100));
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-white mb-4">Simulador de Pre√ßos</h2>
                    <div className="card bg-purple-900/20 border border-purple-500/50">
                        <label className="text-sm text-purple-200 font-bold mb-2 block">1. Digite o Custo Total (CMV) do seu copo:</label>
                        <input type="number" value={custoProd} onChange={e=>setCustoProd(e.target.value)} placeholder="Ex: 3.58" className="text-2xl font-bold text-purple-400 p-4" />
                    </div>
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="card"><label className="text-slate-400 text-sm">Margem de Lucro (%)</label><input type="number" value={lucro} onChange={e=>setLucro(Number(e.target.value))} /></div>
                        <div className="card"><label className="text-slate-400 text-sm">Imposto (%)</label><input type="number" value={imposto} onChange={e=>setImposto(Number(e.target.value))} /></div>
                    </div>
                    
                    <h3 className="text-xl font-bold text-white mb-4">Pre√ßos de Venda Sugeridos:</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {canais.map(c => {
                            const preco = calcular(c);
                            return (
                                <div key={c.id} className="card border-l-4 border-l-purple-500 relative hover:bg-slate-800 transition">
                                    <div className="flex justify-between items-start">
                                        <h4 className="font-bold text-white text-lg">{c.nome}</h4>
                                        <button onClick={()=>setCanalEdit(c)} className="text-xs bg-slate-700 px-3 py-1 rounded text-purple-300 hover:text-white flex gap-1 items-center">
                                            <Icon name="settings" size={14} /> Configurar
                                        </button>
                                    </div>
                                    
                                    {c.desconto_cliente_percentual > 0 && (
                                        <div className="mt-2 inline-block bg-green-900/50 text-green-400 px-2 py-1 rounded text-xs font-bold border border-green-500/50">
                                            üè∑Ô∏è Promo√ß√£o: {c.desconto_cliente_percentual}% OFF
                                        </div>
                                    )}

                                    <div className="mt-3 text-xs text-slate-500 flex gap-2">
                                        <span>Taxa: {c.comissao_percentual}%</span>
                                        <span>Frete: R$ {c.custo_frete_fixo}</span>
                                    </div>
                                    
                                    <div className="flex justify-between items-end mt-4 pt-4 border-t border-slate-700/50">
                                        <div><span className="text-xs text-slate-400 block uppercase">Vender Por</span><span className="text-3xl font-bold text-white">R$ {preco.toFixed(2)}</span></div>
                                        <div className="text-right"><span className="text-xs text-slate-400 block uppercase">Lucro Liq.</span><span className="text-xl font-bold text-green-400">R$ {(preco * (lucro/100)).toFixed(2)}</span></div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>

                    {canalEdit && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-xl font-bold text-white mb-4">Configurar {canalEdit.nome}</h3>
                                <div className="space-y-4">
                                    <div><label className="text-sm text-slate-400">Comiss√£o do App (%)</label><input type="number" value={canalEdit.comissao_percentual} onChange={e=>setCanalEdit({...canalEdit, comissao_percentual: Number(e.target.value)})} /></div>
                                    <div><label className="text-sm text-slate-400">Frete Fixo Pago pela Loja (R$)</label><input type="number" value={canalEdit.custo_frete_fixo} onChange={e=>setCanalEdit({...canalEdit, custo_frete_fixo: Number(e.target.value)})} /></div>
                                    <div className="bg-green-900/20 p-3 rounded border border-green-900/50">
                                        <label className="text-sm text-green-400 font-bold">Desconto Promocional ao Cliente (%)</label>
                                        <input type="number" value={canalEdit.desconto_cliente_percentual} onChange={e=>setCanalEdit({...canalEdit, desconto_cliente_percentual: Number(e.target.value)})} className="border-green-500/50" />
                                        <span className="text-[10px] text-slate-500 block -mt-2">O sistema calcula o pre√ßo "De" para voc√™ vender com desconto real.</span>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button onClick={()=>setCanalEdit(null)} className="btn-danger w-full">Cancelar</button>
                                    <button onClick={salvarCanal} className="btn-success w-full">Salvar Altera√ß√µes</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- M√ìDULO 4: CUSTOS FIXOS ---
        const ModuloCustos = () => {
            const [custos, setCustos] = useState([]);
            const [novo, setNovo] = useState({ nome: '', valor: '' });
            useEffect(() => { load(); }, []);
            async function load() { const {data} = await client.from('custos_fixos').select('*'); if(data) setCustos(data); }
            async function add() { if(!novo.nome || !novo.valor) return; await client.from('custos_fixos').insert([novo]); setNovo({nome:'', valor:''}); load(); }
            async function del(id) { await client.from('custos_fixos').delete().eq('id', id); load(); }
            const total = custos.reduce((acc, i) => acc + Number(i.valor), 0);

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-white mb-4">Custos Fixos Mensais</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="card">
                            <div className="flex gap-2 mb-4">
                                <input placeholder="Descri√ß√£o (Ex: Aluguel, Luz)" value={novo.nome} onChange={e=>setNovo({...novo, nome:e.target.value})} className="flex-1" />
                                <input type="number" placeholder="Valor" value={novo.valor} onChange={e=>setNovo({...novo, valor:e.target.value})} className="w-32" />
                                <button onClick={add} className="btn-primary w-auto">Add</button>
                            </div>
                            <ul className="space-y-2">
                                {custos.map(c => (
                                    <li key={c.id} className="flex justify-between items-center bg-slate-800 p-3 rounded border border-slate-700">
                                        <span className="text-slate-300">{c.nome}</span>
                                        <div className="flex items-center gap-4">
                                            <span className="font-bold text-white">R$ {Number(c.valor).toFixed(2)}</span>
                                            <button onClick={()=>del(c.id)} className="text-red-500 hover:text-red-300"><Icon name="trash-2" size={16}/></button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                            <div className="mt-4 pt-4 border-t border-slate-600 text-right">
                                <span className="text-slate-400 mr-2">Total Mensal:</span>
                                <span className="text-2xl font-bold text-white">R$ {total.toFixed(2)}</span>
                            </div>
                        </div>
                        <div className="card flex flex-col items-center justify-center text-center bg-gradient-to-b from-slate-800 to-slate-900">
                            <div className="p-4 bg-purple-900/30 rounded-full mb-4"><Icon name="target" size={40} className="text-purple-400" /></div>
                            <h3 className="text-lg font-bold text-white">Meta de Vendas (Ponto de Equil√≠brio)</h3>
                            <p className="text-slate-400 text-sm mb-6 px-6">Para pagar os R$ {total.toFixed(0)} de contas fixas (considerando 20% de margem real):</p>
                            <div className="bg-slate-950 p-6 rounded-xl border border-slate-700 w-full max-w-xs">
                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider">Voc√™ precisa faturar</p>
                                <p className="text-3xl font-bold text-green-400 mt-1">R$ {(total / 0.20).toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- M√ìDULO 5: FLUXO DE CAIXA (Corrigido com Categoria) ---
        const ModuloFluxo = () => {
            const [movs, setMovs] = useState([]);
            const [canais, setCanais] = useState([]);
            
            // CORRE√á√ÉO CR√çTICA: Inicializar data e categoria para n√£o dar erro no banco
            const [form, setForm] = useState({ 
                tipo: 'receita', 
                descricao: '', 
                valor: '', 
                data_movimento: new Date().toISOString().split('T')[0], 
                canal_venda_id: '',
                categoria: 'Vendas' 
            });
            
            useEffect(() => { load(); loadCanais(); }, []);
            async function loadCanais() { const {data} = await client.from('canais_venda').select('*'); if(data) setCanais(data); }
            async function load() { const {data} = await client.from('fluxo_caixa').select('*, canais_venda(nome)').order('data_movimento', {ascending: false}); if(data) setMovs(data); }
            
            async function salvar() {
                // Valida√ß√£o
                if (!form.data_movimento || !form.descricao || !form.valor || !form.categoria) {
                    return alert("Preencha Data, Categoria, Descri√ß√£o e Valor!");
                }

                const payload = { 
                    ...form, 
                    canal_venda_id: form.tipo === 'receita' ? form.canal_venda_id : null 
                };
                
                if (!payload.canal_venda_id) delete payload.canal_venda_id; 
                
                const { error } = await client.from('fluxo_caixa').insert([payload]);
                
                if (error) {
                    alert("Erro ao salvar: " + error.message);
                } else {
                    setForm(prev => ({ ...prev, descricao: '', valor: '' })); 
                    load();
                }
            }

            const totais = movs.reduce((acc, m) => {
                const val = Number(m.valor);
                if (m.tipo === 'receita') acc.entradas += val; else acc.saidas += val;
                return acc;
            }, { entradas: 0, saidas: 0 });

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-white mb-4">Fluxo de Caixa</h2>
                    <div className="grid grid-cols-3 gap-4 mb-6">
                        <div className="card border-l-4 border-green-500"><p className="text-xs text-slate-400">ENTRADAS</p><p className="text-2xl font-bold text-green-400">R$ {totais.entradas.toFixed(2)}</p></div>
                        <div className="card border-l-4 border-red-500"><p className="text-xs text-slate-400">SA√çDAS</p><p className="text-2xl font-bold text-red-400">R$ {totais.saidas.toFixed(2)}</p></div>
                        <div className="card border-l-4 border-blue-500"><p className="text-xs text-slate-400">SALDO</p><p className={`text-2xl font-bold ${totais.entradas-totais.saidas>=0?'text-blue-400':'text-red-400'}`}>R$ {(totais.entradas - totais.saidas).toFixed(2)}</p></div>
                    </div>
                    
                    <div className="card border border-slate-600">
                        <h3 className="font-bold text-white mb-4 flex items-center gap-2"><Icon name="plus-circle" /> Novo Lan√ßamento</h3>
                        <div className="grid grid-cols-1 md:grid-cols-6 gap-3">
                            <select value={form.tipo} onChange={e=>setForm({...form, tipo:e.target.value})} className="font-bold"><option value="receita">Receita (+)</option><option value="despesa">Despesa (-)</option></select>
                            <input type="date" value={form.data_movimento} onChange={e=>setForm({...form, data_movimento:e.target.value})} />
                            
                            {/* CAMPO NOVO: CATEGORIA (CORRE√á√ÉO DO ERRO) */}
                            <select value={form.categoria} onChange={e=>setForm({...form, categoria:e.target.value})}>
                                <option value="Vendas">Vendas</option>
                                <option value="Insumos">Insumos</option>
                                <option value="Operacional">Operacional</option>
                                <option value="Pessoal">Pessoal</option>
                                <option value="Outros">Outros</option>
                            </select>

                            <input placeholder="Descri√ß√£o" value={form.descricao} onChange={e=>setForm({...form, descricao:e.target.value})} className="md:col-span-1" />
                            
                            {form.tipo === 'receita' ? (
                                <select value={form.canal_venda_id} onChange={e=>setForm({...form, canal_venda_id:e.target.value})}>
                                    <option value="">Canal...</option>
                                    {canais.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}
                                </select>
                            ) : (<input disabled placeholder="-" className="opacity-50" />)}
                            
                            <input type="number" placeholder="Valor" value={form.valor} onChange={e=>setForm({...form, valor:e.target.value})} />
                        </div>
                        <button onClick={salvar} className="btn-success w-full mt-2 font-bold py-3">LAN√áAR</button>
                    </div>

                    <div className="card overflow-x-auto">
                        <table className="w-full text-left text-sm text-slate-300">
                            <thead><tr className="border-b border-slate-600"><th className="p-3">Data</th><th className="p-3">Desc</th><th className="p-3">Categ.</th><th className="p-3">Canal</th><th className="p-3 text-right">Valor</th></tr></thead>
                            <tbody>
                                {movs.map(m => (
                                    <tr key={m.id} className="border-b border-slate-700/50 hover:bg-slate-800 transition">
                                        <td className="p-3">{new Date(m.data_movimento).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</td>
                                        <td className="p-3 font-medium text-white">{m.descricao}</td>
                                        <td className="p-3 text-xs uppercase bg-slate-800 rounded px-2">{m.categoria || '-'}</td>
                                        <td className="p-3 text-xs uppercase text-slate-400">{m.canais_venda?.nome || '-'}</td>
                                        <td className={`p-3 text-right font-bold ${m.tipo==='receita'?'text-green-400':'text-red-400'}`}>
                                            {m.tipo==='receita'?'+':'-'} R$ {Number(m.valor).toFixed(2)}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- APP SHELL ---
        const App = () => {
            const [aba, setAba] = useState('precificacao');
            if (erroConfig) return <div className="min-h-screen flex items-center justify-center text-red-500 font-bold bg-slate-900 p-10 border border-red-500 m-10 rounded">{erroConfig}</div>;

            const NavItem = ({id, icon, label}) => (
                <button onClick={()=>setAba(id)} className={`flex items-center gap-3 p-3 rounded transition w-full ${aba===id?'bg-purple-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800'}`}>
                    <Icon name={icon} /> <span className="font-medium">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <aside className="w-full md:w-64 bg-slate-900 border-r border-slate-800 p-4 flex flex-col gap-2">
                        <div className="mb-6 p-2"><h1 className="text-2xl font-bold text-purple-400 flex items-center gap-2"><Icon name="zap" /> A√ßa√≠Metrics</h1><p className="text-xs text-slate-500 mt-1">Vers√£o 9.7 Final</p></div>
                        <nav className="flex-1 space-y-1">
                            <NavItem id="estoque" icon="package" label="1. Estoque" />
                            <NavItem id="produtos" icon="coffee" label="2. Meus Produtos" />
                            <NavItem id="precificacao" icon="calculator" label="3. Precifica√ß√£o" />
                            <NavItem id="custos" icon="wallet" label="4. Custos Fixos" />
                            <NavItem id="fluxo" icon="bar-chart-3" label="5. Fluxo de Caixa" />
                        </nav>
                    </aside>
                    <main className="flex-1 p-6 overflow-y-auto">
                        {aba === 'estoque' && <ModuloEstoque />}
                        {aba === 'produtos' && <ModuloProdutos />}
                        {aba === 'precificacao' && <ModuloPrecificacao />}
                        {aba === 'custos' && <ModuloCustos />}
                        {aba === 'fluxo' && <ModuloFluxo />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>