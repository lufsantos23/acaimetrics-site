<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A√ßa√≠Metrics | v11.0 Combos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; margin-bottom: 20px; }
        input, select { background-color: #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; border: 1px solid #475569; margin-bottom: 10px; outline: none; }
        input:focus, select:focus { border-color: #9333ea; }
        button { cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-primary { background-color: #9333ea; color: white; font-weight: bold; padding: 10px 20px; border-radius: 8px; width: 100%; }
        .btn-success { background-color: #16a34a; color: white; font-weight: bold; padding: 10px 20px; border-radius: 8px; width: 100%; }
        .btn-warning { background-color: #f59e0b; color: black; font-weight: bold; padding: 10px 20px; border-radius: 8px; width: 100%; }
        .btn-danger { color: #f87171; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #475569; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        
        /* Anima√ß√£o suave */
        .highlight { animation: highlightPulse 1s; }
        @keyframes highlightPulse { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
    </style>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.body.innerHTML = '<div style="color:red; padding:20px; background:#330000; font-size:18px; font-family:monospace;"><h1>Erro Cr√≠tico Detectado!</h1><p>'+message+'</p><p>Linha: '+lineno+'</p></div>';
        };
    </script>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==========================================================
        // ‚ö†Ô∏è COLE SUAS CHAVES ABAIXO
        // ==========================================================
        
        // 1. Cole a URL do Supabase aqui
        const SUPABASE_URL = "https://gmbtewbpojuqrnehrfmk.supabase.co"; 
        
        // 2. Cole a KEY (anon public) aqui
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtYnRld2Jwb2p1cXJuZWhyZm1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyODE0MTQsImV4cCI6MjA4MTg1NzQxNH0.F2K_ZzXCJAFDplTqSK0ubq5zfSXItjIatZnb-pdOAOQ";
        
        // ==========================================================

        let client = null;
        let erroConfig = null;

        try {
            if (!SUPABASE_URL || SUPABASE_URL.includes("SEU_ID")) throw new Error("ERRO: Configure a URL do Supabase na linha 62.");
            if (!SUPABASE_KEY || SUPABASE_KEY.includes("SUA_KEY")) throw new Error("ERRO: Configure a CHAVE do Supabase na linha 65.");
            client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (err) {
            erroConfig = err.message;
        }

        const Icon = ({ name, size=20 }) => {
            useEffect(() => { if(lucide) lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }}></i>;
        };

        // --- M√ìDULO 1: ESTOQUE ---
        const ModuloEstoque = () => {
            const [items, setItems] = useState([]);
            const [editando, setEditando] = useState(null);
            const [form, setForm] = useState({ nome: '', unidade_medida: 'G', categoria: 'ingrediente', preco_embalagem: '', tamanho_embalagem: '' });

            useEffect(() => { carregar(); }, []);
            async function carregar() { const { data } = await client.from('insumos').select('*').order('nome'); if (data) setItems(data); }

            function prepararEdicao(item) {
                setEditando(item.id);
                setForm({ 
                    nome: item.nome, categoria: item.categoria, unidade_medida: item.unidade_medida, 
                    preco_embalagem: '', tamanho_embalagem: '' 
                });
                window.scrollTo(0,0);
            }

            function cancelarEdicao() {
                setEditando(null);
                setForm({ nome: '', unidade_medida: 'G', categoria: 'ingrediente', preco_embalagem: '', tamanho_embalagem: '' });
            }

            async function salvar() {
                if (!form.nome || !form.preco_embalagem || !form.tamanho_embalagem) return alert("Preencha todos os campos!");
                const custoCalculado = Number(form.preco_embalagem) / Number(form.tamanho_embalagem);
                const payload = { nome: form.nome, categoria: form.categoria, unidade_medida: form.unidade_medida, custo_atual: custoCalculado };

                if (editando) { await client.from('insumos').update(payload).eq('id', editando); alert("Atualizado!"); } 
                else { await client.from('insumos').insert([payload]); }
                cancelarEdicao(); carregar();
            }
            async function excluir(id) { if (confirm("Apagar?")) { await client.from('insumos').delete().eq('id', id); carregar(); } }

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-white mb-4">Estoque & Insumos</h2>
                    <div className={`card ${editando ? 'border-orange-500 border-2' : ''}`}>
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-white">{editando ? '‚úèÔ∏è Editando' : 'Novo Item'}</h3>{editando && <button onClick={cancelarEdicao} className="text-red-400 text-xs">Cancelar</button>}</div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label className="text-xs text-slate-400">Nome</label><input value={form.nome} onChange={e=>setForm({...form, nome:e.target.value})} /></div>
                            <div><label className="text-xs text-slate-400">Categoria</label><select value={form.categoria} onChange={e=>setForm({...form, categoria:e.target.value})}><option value="ingrediente">Ingrediente</option><option value="embalagem">Embalagem</option></select></div>
                            <div><label className="text-xs text-slate-400">Pre√ßo Pago (R$)</label><input type="number" value={form.preco_embalagem} onChange={e=>setForm({...form, preco_embalagem:e.target.value})} /></div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs text-slate-400">Qtd Total</label><input type="number" value={form.tamanho_embalagem} onChange={e=>setForm({...form, tamanho_embalagem:e.target.value})} /></div>
                                <div className="w-1/3"><label className="text-xs text-slate-400">Unid</label><select value={form.unidade_medida} onChange={e=>setForm({...form, unidade_medida:e.target.value})}><option value="G">G</option><option value="ML">ML</option><option value="UN">UN</option></select></div>
                            </div>
                        </div>
                        <button onClick={salvar} className={editando ? "btn-warning" : "btn-primary"}>{editando ? 'Atualizar' : 'Salvar'}</button>
                    </div>
                    <div className="card overflow-x-auto">
                        <table className="w-full text-left text-sm text-slate-300">
                            <thead><tr className="border-b border-slate-600"><th className="p-3">Nome</th><th className="p-3">Custo Unit.</th><th className="p-3 text-right">A√ß√µes</th></tr></thead>
                            <tbody>
                                {items.map(i => (
                                    <tr key={i.id} className="border-b border-slate-700/50">
                                        <td className="p-3 text-white">{i.nome}</td>
                                        <td className="p-3 text-green-400">R$ {Number(i.custo_atual).toFixed(4)} / {i.unidade_medida}</td>
                                        <td className="p-3 text-right flex justify-end gap-3">
                                            <button onClick={()=>prepararEdicao(i)} className="text-blue-400"><Icon name="pencil" size={18}/></button>
                                            <button onClick={()=>excluir(i.id)} className="text-red-400"><Icon name="trash-2" size={18}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- M√ìDULO 2: MEUS PRODUTOS ---
        const ModuloProdutos = () => {
            const [produtos, setProdutos] = useState([]);
            const [nomeNovo, setNomeNovo] = useState('');
            const [produtoEdit, setProdutoEdit] = useState(null);

            useEffect(() => { carregar(); }, []);
            async function carregar() { const { data } = await client.from('produtos').select('*').order('created_at'); if(data) setProdutos(data); }
            async function criar() { if(!nomeNovo) return; await client.from('produtos').insert([{ nome: nomeNovo, preco_base: 0 }]); setNomeNovo(''); carregar(); }
            async function excluirProduto(id) { if(confirm("Apagar produto?")) { await client.from('produtos').delete().eq('id', id); carregar(); } }
            async function salvarEdicao() { if(!produtoEdit?.nome) return; await client.from('produtos').update({ nome: produtoEdit.nome }).eq('id', produtoEdit.id); setProdutoEdit(null); carregar(); }

            const DetalheReceita = ({ produto }) => {
                const [itens, setItens] = useState([]);
                const [insumos, setInsumos] = useState([]);
                const [addId, setAddId] = useState('');
                const [addQtd, setAddQtd] = useState('');

                useEffect(() => { loadItens(); loadInsumos(); }, []);
                async function loadInsumos() { const {data} = await client.from('insumos').select('*').order('nome'); if(data) setInsumos(data); }
                async function loadItens() { const {data} = await client.from('itens_receita').select('*, insumos(*)').eq('produto_id', produto.id); if(data) setItens(data); }
                async function adicionar() { if(!addId || !addQtd) return; await client.from('itens_receita').insert([{ produto_id: produto.id, insumo_id: addId, quantidade: addQtd }]); setAddQtd(''); loadItens(); }
                async function remover(id) { await client.from('itens_receita').delete().eq('id', id); loadItens(); }
                const custoTotal = itens.reduce((acc, i) => acc + (Number(i.quantidade) * Number(i.insumos?.custo_atual||0)), 0);

                return (
                    <div className="mt-4 bg-slate-900 p-4 rounded border border-slate-700">
                        {itens.map(i => (
                            <div key={i.id} className="flex justify-between text-sm mb-2 border-b border-slate-800 pb-1">
                                <span>{i.insumos?.nome} ({Number(i.quantidade)} {i.insumos?.unidade_medida})</span>
                                <div className="flex gap-4"><span className="text-green-400 font-mono">R$ {(Number(i.quantidade)*Number(i.insumos?.custo_atual)).toFixed(2)}</span><button onClick={()=>remover(i.id)} className="text-red-500 font-bold">X</button></div>
                            </div>
                        ))}
                        <div className="flex gap-2 mt-4">
                            <select value={addId} onChange={e=>setAddId(e.target.value)} className="text-sm flex-1"><option value="">+ Item...</option>{insumos.map(i=><option key={i.id} value={i.id}>{i.nome}</option>)}</select>
                            <input type="number" placeholder="Qtd" value={addQtd} onChange={e=>setAddQtd(e.target.value)} className="w-20 text-sm" />
                            <button onClick={adicionar} className="bg-green-600 px-3 rounded text-white font-bold">+</button>
                        </div>
                        <div className="mt-4 pt-3 border-t border-slate-700 flex justify-between items-center"><span className="text-slate-400">Custo Total (CMV):</span><span className="text-xl font-bold text-green-400">R$ {custoTotal.toFixed(2)}</span></div>
                    </div>
                );
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-white mb-4">Engenharia de Card√°pio</h2>
                    <div className="card flex gap-2"><input placeholder="Nome do Produto" value={nomeNovo} onChange={e=>setNomeNovo(e.target.value)} /><button onClick={criar} className="btn-primary w-auto">Criar Produto</button></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {produtos.map(p => (
                            <div key={p.id} className="card relative">
                                <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-lg text-white flex gap-2"><Icon name="coffee" /> {p.nome}</h3><div className="flex gap-2"><button onClick={()=>setProdutoEdit(p)} className="bg-slate-800 p-2 rounded text-blue-400"><Icon name="pencil" size={16}/></button><button onClick={()=>excluirProduto(p.id)} className="bg-slate-800 p-2 rounded text-red-400"><Icon name="trash-2" size={16}/></button></div></div>
                                <DetalheReceita produto={p} />
                            </div>
                        ))}
                    </div>
                    {produtoEdit && <div className="modal-overlay"><div className="modal-content"><h3 className="text-xl font-bold text-white mb-4">Renomear</h3><input value={produtoEdit.nome} onChange={e=>setProdutoEdit({...produtoEdit, nome:e.target.value})} className="mb-4" /><div className="flex gap-2"><button onClick={()=>setProdutoEdit(null)} className="btn-danger w-full">Cancelar</button><button onClick={salvarEdicao} className="btn-success w-full">Salvar</button></div></div></div>}
                </div>
            );
        };

        // --- M√ìDULO 3: PRECIFICA√á√ÉO ---
        const ModuloPrecificacao = () => {
            const [custoProd, setCustoProd] = useState('');
            const [lucro, setLucro] = useState(20);
            const [imposto, setImposto] = useState(4);
            const [canais, setCanais] = useState([]);
            const [canalEdit, setCanalEdit] = useState(null);

            useEffect(() => { carregarCanais(); }, []);
            async function carregarCanais() { const { data } = await client.from('canais_venda').select('*'); if (data) setCanais(data); }
            async function salvarCanal() { if(!canalEdit) return; await client.from('canais_venda').update({ comissao_percentual: canalEdit.comissao_percentual, custo_frete_fixo: canalEdit.custo_frete_fixo, cupom_desconto_fixo: canalEdit.cupom_desconto_fixo, desconto_cliente_percentual: canalEdit.desconto_cliente_percentual }).eq('id', canalEdit.id); setCanalEdit(null); carregarCanais(); }

            const calcular = (canal) => {
                const custoBase = Number(custoProd);
                const fixos = custoBase + Number(canal.custo_frete_fixo||0) + Number(canal.cupom_desconto_fixo||0);
                const percentuais = imposto + Number(canal.comissao_percentual||0) + Number(canal.desconto_cliente_percentual||0) + lucro;
                if (percentuais >= 100) return 0;
                return fixos / (1 - (percentuais / 100));
            };

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-white mb-4">Simulador de Pre√ßos</h2>
                    <div className="card bg-purple-900/20 border border-purple-500/50"><label className="text-sm text-purple-200 font-bold mb-2 block">1. Digite o Custo Total (CMV) do seu copo:</label><input type="number" value={custoProd} onChange={e=>setCustoProd(e.target.value)} placeholder="Ex: 3.58" className="text-2xl font-bold text-purple-400 p-4" /></div>
                    <div className="grid grid-cols-2 gap-4 mb-6"><div className="card"><label className="text-slate-400 text-sm">Margem de Lucro (%)</label><input type="number" value={lucro} onChange={e=>setLucro(Number(e.target.value))} /></div><div className="card"><label className="text-slate-400 text-sm">Imposto (%)</label><input type="number" value={imposto} onChange={e=>setImposto(Number(e.target.value))} /></div></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {canais.map(c => {
                            const preco = calcular(c);
                            return (
                                <div key={c.id} className="card border-l-4 border-l-purple-500 relative hover:bg-slate-800 transition">
                                    <div className="flex justify-between items-start"><h4 className="font-bold text-white text-lg">{c.nome}</h4><button onClick={()=>setCanalEdit(c)} className="text-xs bg-slate-700 px-3 py-1 rounded text-purple-300 flex gap-1 items-center"><Icon name="settings" size={14} /> Config</button></div>
                                    <div className="flex justify-between items-end mt-4 pt-4 border-t border-slate-700/50"><div><span className="text-xs text-slate-400 block uppercase">Vender Por</span><span className="text-3xl font-bold text-white">R$ {preco.toFixed(2)}</span></div><div className="text-right"><span className="text-xs text-slate-400 block uppercase">Lucro Liq.</span><span className="text-xl font-bold text-green-400">R$ {(preco * (lucro/100)).toFixed(2)}</span></div></div>
                                </div>
                            )
                        })}
                    </div>
                    {canalEdit && <div className="modal-overlay"><div className="modal-content"><h3 className="text-xl font-bold text-white mb-4">Configurar {canalEdit.nome}</h3><div className="space-y-4"><div><label className="text-sm text-slate-400">Taxa App (%)</label><input type="number" value={canalEdit.comissao_percentual} onChange={e=>setCanalEdit({...canalEdit, comissao_percentual: Number(e.target.value)})} /></div><div><label className="text-sm text-slate-400">Frete Fixo (R$)</label><input type="number" value={canalEdit.custo_frete_fixo} onChange={e=>setCanalEdit({...canalEdit, custo_frete_fixo: Number(e.target.value)})} /></div><div><label className="text-sm text-slate-400">Desconto Cliente (%)</label><input type="number" value={canalEdit.desconto_cliente_percentual} onChange={e=>setCanalEdit({...canalEdit, desconto_cliente_percentual: Number(e.target.value)})} /></div></div><div className="flex gap-2 mt-6"><button onClick={()=>setCanalEdit(null)} className="btn-danger w-full">Cancelar</button><button onClick={salvarCanal} className="btn-success w-full">Salvar</button></div></div></div>}
                </div>
            );
        };

        // --- M√ìDULO 4: CUSTOS FIXOS ---
        const ModuloCustos = () => {
            const [custos, setCustos] = useState([]);
            const [novo, setNovo] = useState({ nome: '', valor: '' });
            const [editando, setEditando] = useState(null);

            useEffect(() => { load(); }, []);
            async function load() { const {data} = await client.from('custos_fixos').select('*'); if(data) setCustos(data); }
            async function salvar() { 
                if(!novo.nome || !novo.valor) return; 
                if (editando) { await client.from('custos_fixos').update(novo).eq('id', editando); setEditando(null); } 
                else { await client.from('custos_fixos').insert([novo]); }
                setNovo({nome:'', valor:''}); load(); 
            }
            function prepararEdicao(item) { setNovo({ nome: item.nome, valor: item.valor }); setEditando(item.id); }
            async function del(id) { await client.from('custos_fixos').delete().eq('id', id); load(); }
            const total = custos.reduce((acc, i) => acc + Number(i.valor), 0);

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-white mb-4">Custos Fixos Mensais</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className={`card ${editando ? 'border-orange-500 border-2' : ''}`}>
                            <div className="flex gap-2 mb-4 items-end"><div className="flex-1"><label className="text-xs text-slate-400 mb-1 block">Descri√ß√£o</label><input placeholder="Ex: Aluguel" value={novo.nome} onChange={e=>setNovo({...novo, nome:e.target.value})} className="mb-0" /></div><div className="w-32"><label className="text-xs text-slate-400 mb-1 block">Valor (R$)</label><input type="number" placeholder="0.00" value={novo.valor} onChange={e=>setNovo({...novo, valor:e.target.value})} className="mb-0" /></div><button onClick={salvar} className={`mb-0 px-4 py-2 rounded font-bold text-white ${editando ? 'bg-orange-500' : 'bg-purple-600'}`}>{editando ? 'OK' : 'Add'}</button></div>
                            {editando && <p className="text-right text-xs text-orange-400 cursor-pointer mb-2" onClick={()=>{setEditando(null); setNovo({nome:'', valor:''})}}>Cancelar Edi√ß√£o</p>}
                            <ul className="space-y-2 mt-4">{custos.map(c => (<li key={c.id} className="flex justify-between items-center bg-slate-800 p-3 rounded border border-slate-700"><span className="text-slate-300">{c.nome}</span><div className="flex items-center gap-4"><span className="font-bold text-white">R$ {Number(c.valor).toFixed(2)}</span><div className="flex gap-2"><button onClick={()=>prepararEdicao(c)} className="text-blue-400"><Icon name="pencil" size={16}/></button><button onClick={()=>del(c.id)} className="text-red-500"><Icon name="trash-2" size={16}/></button></div></div></li>))}</ul>
                            <div className="mt-4 pt-4 border-t border-slate-600 text-right"><span className="text-slate-400 mr-2">Total Mensal:</span><span className="text-2xl font-bold text-white">R$ {total.toFixed(2)}</span></div>
                        </div>
                        <div className="card flex flex-col items-center justify-center text-center bg-gradient-to-b from-slate-800 to-slate-900 gap-4">
                            <div className="w-full space-y-4">
                                <div className="bg-slate-950 p-4 rounded-xl border border-yellow-900/50 w-full"><p className="text-xs text-yellow-500 uppercase font-bold tracking-wider">‚öñÔ∏è Ponto de Equil√≠brio (Zero a Zero)</p><p className="text-2xl font-bold text-yellow-400 mt-1">R$ {(total / 0.40).toFixed(2)}</p></div>
                                <div className="bg-slate-950 p-4 rounded-xl border border-green-900/50 w-full"><p className="text-xs text-green-500 uppercase font-bold tracking-wider">üöÄ Meta Ideal (Lucro Real)</p><p className="text-3xl font-bold text-green-400 mt-1">R$ {(total / 0.20).toFixed(2)}</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- M√ìDULO 5: FLUXO DE CAIXA ---
        const ModuloFluxo = () => {
            const [movs, setMovs] = useState([]);
            const [canais, setCanais] = useState([]);
            const [editando, setEditando] = useState(null);
            const [form, setForm] = useState({ tipo: 'receita', descricao: '', valor: '', data_movimento: new Date().toISOString().split('T')[0], canal_venda_id: '', categoria: 'Vendas' });
            
            useEffect(() => { load(); loadCanais(); }, []);
            async function loadCanais() { const {data} = await client.from('canais_venda').select('*'); if(data) setCanais(data); }
            async function load() { const {data} = await client.from('fluxo_caixa').select('*, canais_venda(nome)').order('data_movimento', {ascending: false}); if(data) setMovs(data); }
            
            function prepararEdicao(item) { setEditando(item.id); setForm({ tipo: item.tipo, descricao: item.descricao, valor: item.valor, data_movimento: item.data_movimento, canal_venda_id: item.canal_venda_id || '', categoria: item.categoria || 'Vendas' }); window.scrollTo(0, 0); }
            function cancelarEdicao() { setEditando(null); setForm({ tipo: 'receita', descricao: '', valor: '', data_movimento: new Date().toISOString().split('T')[0], canal_venda_id: '', categoria: 'Vendas' }); }

            async function salvar() {
                if (!form.data_movimento || !form.descricao || !form.valor || !form.categoria) return alert("Preencha tudo!");
                const payload = { ...form, canal_venda_id: form.tipo === 'receita' ? form.canal_venda_id : null };
                if (!payload.canal_venda_id) delete payload.canal_venda_id; 
                if (editando) { await client.from('fluxo_caixa').update(payload).eq('id', editando); alert("Corrigido!"); cancelarEdicao(); load(); } 
                else { await client.from('fluxo_caixa').insert([payload]); setForm(prev => ({ ...prev, descricao: '', valor: '' })); load(); }
            }
            async function excluir(id) { if(confirm("Apagar?")) { await client.from('fluxo_caixa').delete().eq('id', id); load(); } }
            const totais = movs.reduce((acc, m) => { const val = Number(m.valor); if (m.tipo === 'receita') acc.entradas += val; else acc.saidas += val; return acc; }, { entradas: 0, saidas: 0 });

            return (
                <div className="space-y-6">
                    <h2 className="text-2xl font-bold text-white mb-4">Fluxo de Caixa</h2>
                    <div className="grid grid-cols-3 gap-4 mb-6"><div className="card border-l-4 border-green-500"><p className="text-xs text-slate-400">ENTRADAS</p><p className="text-2xl font-bold text-green-400">R$ {totais.entradas.toFixed(2)}</p></div><div className="card border-l-4 border-red-500"><p className="text-xs text-slate-400">SA√çDAS</p><p className="text-2xl font-bold text-red-400">R$ {totais.saidas.toFixed(2)}</p></div><div className="card border-l-4 border-blue-500"><p className="text-xs text-slate-400">SALDO</p><p className={`text-2xl font-bold ${totais.entradas-totais.saidas>=0?'text-blue-400':'text-red-400'}`}>R$ {(totais.entradas - totais.saidas).toFixed(2)}</p></div></div>
                    <div className={`card border border-slate-600 ${editando ? 'border-orange-500 border-2' : ''}`}>
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-white flex items-center gap-2"><Icon name={editando ? "pencil" : "plus-circle"} /> {editando ? "Editando" : "Novo Lan√ßamento"}</h3>{editando && <button onClick={cancelarEdicao} className="text-red-400 text-sm underline">Cancelar</button>}</div>
                        <div className="grid grid-cols-1 md:grid-cols-6 gap-3">
                            <select value={form.tipo} onChange={e=>setForm({...form, tipo:e.target.value})} className="font-bold"><option value="receita">Receita (+)</option><option value="despesa">Despesa (-)</option></select>
                            <input type="date" value={form.data_movimento} onChange={e=>setForm({...form, data_movimento:e.target.value})} />
                            <select value={form.categoria} onChange={e=>setForm({...form, categoria:e.target.value})}><option value="Vendas">Vendas</option><option value="Insumos">Insumos</option><option value="Operacional">Operacional</option><option value="Pessoal">Pessoal</option><option value="Outros">Outros</option></select>
                            <input placeholder="Descri√ß√£o" value={form.descricao} onChange={e=>setForm({...form, descricao:e.target.value})} className="md:col-span-1" />
                            {form.tipo === 'receita' ? (<select value={form.canal_venda_id} onChange={e=>setForm({...form, canal_venda_id:e.target.value})}><option value="">Canal...</option>{canais.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select>) : (<input disabled placeholder="-" className="opacity-50" />)}
                            <input type="number" placeholder="Valor" value={form.valor} onChange={e=>setForm({...form, valor:e.target.value})} />
                        </div>
                        <button onClick={salvar} className={`w-full mt-2 font-bold py-3 rounded ${editando ? 'btn-warning' : 'btn-success'}`}>{editando ? 'ATUALIZAR' : 'LAN√áAR'}</button>
                    </div>
                    <div className="card overflow-x-auto"><table className="w-full text-left text-sm text-slate-300"><thead><tr className="border-b border-slate-600"><th className="p-3">Data</th><th className="p-3">Desc</th><th className="p-3">Categ</th><th className="p-3">Valor</th><th className="p-3 text-right">A√ß√µes</th></tr></thead><tbody>{movs.map(m => (<tr key={m.id} className="border-b border-slate-700/50"><td className="p-3">{new Date(m.data_movimento).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</td><td className="p-3 text-white">{m.descricao}</td><td className="p-3 text-xs uppercase">{m.categoria}</td><td className={`p-3 font-bold ${m.tipo==='receita'?'text-green-400':'text-red-400'}`}>{m.tipo==='receita'?'+':'-'} {Number(m.valor).toFixed(2)}</td><td className="p-3 text-right flex justify-end gap-3"><button onClick={()=>prepararEdicao(m)} className="text-blue-400"><Icon name="pencil" size={16}/></button><button onClick={()=>excluir(m.id)} className="text-red-400"><Icon name="trash-2" size={16}/></button></td></tr>))}</tbody></table></div>
                </div>
            );
        };

        // --- M√ìDULO 6: COMBOS (CORRIGIDO) ---
        const ModuloCombos = () => {
            const [combos, setCombos] = useState([]);
            const [produtos, setProdutos] = useState([]);
            const [custosPorProduto, setCustosPorProduto] = useState({});
            
            // Controle de Edi√ß√£o/Cria√ß√£o
            const [editandoId, setEditandoId] = useState(null);
            const [formNome, setFormNome] = useState('');
            const [formPreco, setFormPreco] = useState('');
            const [itensCombo, setItensCombo] = useState([]); 

            useEffect(() => { carregarDados(); }, []);

            async function carregarDados() {
                const { data: c } = await client.from('combos').select('*').order('created_at');
                if (c) setCombos(c);
                const { data: p } = await client.from('produtos').select('*');
                if (p) setProdutos(p);
                
                // M√°gica para calcular custo de cada produto
                const { data: receitas } = await client.from('itens_receita').select('*, insumos(*)');
                if (receitas && p) {
                    const mapaCustos = {};
                    p.forEach(prod => {
                        const receitaDoProd = receitas.filter(r => r.produto_id === prod.id);
                        const custo = receitaDoProd.reduce((acc, r) => acc + (Number(r.quantidade) * Number(r.insumos?.custo_atual || 0)), 0);
                        mapaCustos[prod.id] = custo;
                    });
                    setCustosPorProduto(mapaCustos);
                }
            }

            async function abrirEditor(combo) {
                if (combo) {
                    setEditandoId(combo.id);
                    setFormNome(combo.nome);
                    setFormPreco(combo.preco_venda);
                    const { data } = await client.from('itens_combo').select('*').eq('combo_id', combo.id);
                    setItensCombo(data || []);
                } else {
                    setEditandoId('NOVO');
                    setFormNome('');
                    setFormPreco('');
                    setItensCombo([]);
                }
            }

            function adicionarItemNoCombo(prodId) {
                if (!prodId) return;
                // CORRE√á√ÉO AQUI: Removemos o Number() pois o ID agora √© texto (UUID)
                setItensCombo([...itensCombo, { produto_id: prodId, quantidade: 1, tempId: Date.now() }]);
            }

            function removerItemDoCombo(index) {
                const novaLista = [...itensCombo];
                novaLista.splice(index, 1);
                setItensCombo(novaLista);
            }

            async function salvarCombo() {
                if (!formNome || !formPreco) return alert("Preencha nome e pre√ßo!");
                
                let comboId = editandoId;

                // 1. Salvar ou Criar o Combo Pai
                if (editandoId === 'NOVO') {
                    const { data, error } = await client.from('combos').insert([{ nome: formNome, preco_venda: formPreco }]).select();
                    if (error) return alert("Erro ao criar combo: " + error.message);
                    comboId = data[0].id;
                } else {
                    await client.from('combos').update({ nome: formNome, preco_venda: formPreco }).eq('id', comboId);
                    await client.from('itens_combo').delete().eq('combo_id', comboId);
                }

                // 2. Salvar os Itens
                const itensParaSalvar = itensCombo.map(i => ({ combo_id: comboId, produto_id: i.produto_id, quantidade: 1 }));
                if (itensParaSalvar.length > 0) {
                    const { error } = await client.from('itens_combo').insert(itensParaSalvar);
                    if(error) console.log(error);
                }

                setEditandoId(null);
                carregarDados();
            }

            async function excluirCombo(id) {
                if(confirm("Apagar este combo?")) {
                    await client.from('combos').delete().eq('id', id);
                    carregarDados();
                }
            }

            const custoTotalCombo = itensCombo.reduce((acc, item) => acc + (custosPorProduto[item.produto_id] || 0), 0);
            const lucro = Number(formPreco) - custoTotalCombo;
            const margem = Number(formPreco) > 0 ? (lucro / Number(formPreco)) * 100 : 0;

            if (editandoId) {
                return (
                    <div className="space-y-6 animate-fade">
                         <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-white">Montando Combo</h2><button onClick={()=>setEditandoId(null)} className="text-red-400 underline">Voltar</button></div>
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="card">
                                <label className="text-sm text-slate-400">Nome do Combo</label>
                                <input value={formNome} onChange={e=>setFormNome(e.target.value)} placeholder="Ex: Casal Apaixonado (2 A√ßa√≠s)" />
                                
                                <label className="text-sm text-slate-400 mt-4 block">Itens do Combo</label>
                                <select onChange={(e)=>adicionarItemNoCombo(e.target.value)} value="">
                                    <option value="">+ Adicionar Produto...</option>
                                    {produtos.map(p => <option key={p.id} value={p.id}>{p.nome}</option>)}
                                </select>
                                <div className="mt-2 space-y-2">
                                    {itensCombo.map((item, idx) => {
                                        const prod = produtos.find(p => p.id === item.produto_id);
                                        return (
                                            <div key={idx} className="flex justify-between bg-slate-800 p-2 rounded items-center">
                                                <span className="text-sm text-white">{prod?.nome}</span>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xs text-slate-500">Custo: R$ {custosPorProduto[item.produto_id]?.toFixed(2)}</span>
                                                    <button onClick={()=>removerItemDoCombo(idx)} className="text-red-500 font-bold">X</button>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                            
                            <div className="card bg-slate-900 border border-purple-500/30">
                                <h3 className="font-bold text-purple-400 mb-4">An√°lise Financeira</h3>
                                <div className="flex justify-between mb-2"><span className="text-slate-400">Custo dos Itens (CMV):</span><span className="font-bold text-red-400">R$ {custoTotalCombo.toFixed(2)}</span></div>
                                
                                <label className="text-sm text-white mt-4 block font-bold">Por quanto vai vender?</label>
                                <input type="number" className="text-2xl font-bold text-green-400" value={formPreco} onChange={e=>setFormPreco(e.target.value)} placeholder="0.00" />
                                
                                <div className="mt-4 pt-4 border-t border-slate-700 space-y-2">
                                    <div className="flex justify-between"><span className="text-slate-300">Lucro Bruto:</span><span className="font-bold text-green-400">R$ {lucro.toFixed(2)}</span></div>
                                    <div className="flex justify-between"><span className="text-slate-300">Margem:</span><span className={`font-bold ${margem<20?'text-red-500':'text-green-500'}`}>{margem.toFixed(1)}%</span></div>
                                </div>
                                <button onClick={salvarCombo} className="btn-success w-full mt-6">Salvar Combo</button>
                            </div>
                         </div>
                    </div>
                )
            }

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-white">Meus Combos</h2><button onClick={()=>abrirEditor(null)} className="btn-primary w-auto">+ Novo Combo</button></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {combos.map(c => (
                            <div key={c.id} className="card relative hover:bg-slate-800 transition">
                                <div className="flex justify-between items-start">
                                    <div><h3 className="font-bold text-lg text-white">{c.nome}</h3><p className="text-2xl font-bold text-green-400 mt-1">R$ {Number(c.preco_venda).toFixed(2)}</p></div>
                                    <div className="flex gap-2"><button onClick={()=>abrirEditor(c)} className="bg-slate-700 p-2 rounded text-blue-400"><Icon name="pencil" size={16}/></button><button onClick={()=>excluirCombo(c.id)} className="bg-slate-700 p-2 rounded text-red-400"><Icon name="trash-2" size={16}/></button></div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- APP SHELL ---
        const App = () => {
            const [aba, setAba] = useState('precificacao');
            if (erroConfig) return <div className="min-h-screen flex items-center justify-center text-red-500 font-bold bg-slate-900 p-10 border border-red-500 m-10 rounded">{erroConfig}</div>;

            const NavItem = ({id, icon, label}) => (<button onClick={()=>setAba(id)} className={`flex items-center gap-3 p-3 rounded transition w-full ${aba===id?'bg-purple-600 text-white shadow-lg':'text-slate-400 hover:bg-slate-800'}`}><Icon name={icon} /> <span className="font-medium">{label}</span></button>);

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <aside className="w-full md:w-64 bg-slate-900 border-r border-slate-800 p-4 flex flex-col gap-2">
                        <div className="mb-6 p-2"><h1 className="text-2xl font-bold text-purple-400 flex items-center gap-2"><Icon name="zap" /> A√ßa√≠Metrics</h1><p className="text-xs text-slate-500 mt-1">Vers√£o 11.0 Combos</p></div>
                        <nav className="flex-1 space-y-1">
                            <NavItem id="estoque" icon="package" label="1. Estoque" />
                            <NavItem id="produtos" icon="coffee" label="2. Produtos" />
                            <NavItem id="combos" icon="layers" label="3. Combos (Novo)" />
                            <NavItem id="precificacao" icon="calculator" label="4. Precifica√ß√£o" />
                            <NavItem id="custos" icon="wallet" label="5. Custos Fixos" />
                            <NavItem id="fluxo" icon="bar-chart-3" label="6. Fluxo Caixa" />
                        </nav>
                    </aside>
                    <main className="flex-1 p-6 overflow-y-auto">
                        {aba === 'estoque' && <ModuloEstoque />}
                        {aba === 'produtos' && <ModuloProdutos />}
                        {aba === 'combos' && <ModuloCombos />}
                        {aba === 'precificacao' && <ModuloPrecificacao />}
                        {aba === 'custos' && <ModuloCustos />}
                        {aba === 'fluxo' && <ModuloFluxo />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>